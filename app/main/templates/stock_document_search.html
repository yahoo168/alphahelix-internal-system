<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Upload with Bootstrap</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #modalContent {
      white-space: pre-wrap; /* 保持换行符，并自动换行 */
      word-wrap: break-word; /* 长单词换行 */
      overflow-wrap: break-word; /* 长单词换行 */
    }
    .modal-dialog {
      max-width: 120%; /* 模态框最大宽度 */
      max-height: 80%; /* 模态框最大高度 */
      resize: both; /* 允许模态框调整大小 */
      overflow: auto; /* 允许内容滚动 */
    }
    .modal-content {
      height: 100%;
    }
    .modal-resizable {
      position: relative;
    }
  </style>
  {% extends "main_base.html" %}
</head>
{% block content %}
<body>
  <div class="container mt-5">
    <h1>個股文件查詢</h1>
    <form action="{{ url_for('main.stock_document_search') }}" method="post" enctype="multipart/form-data">
      <div class="form-group">
        <label for="country">Country</label>
        <select class="form-control" id="country" name="country">
          <option value="US">US</option>
          <option value="TW">TW</option>
        </select>
      </div>
      <div class="form-group">
        <label for="ticker">Ticker</label>
        <input type="text" class="form-control" id="ticker" name="ticker" placeholder="2330, 2454... (可輸入多個，以逗號分隔)" required />
      </div>
      <div class="form-group">
        <label for="document_type">Document Type</label>
        <select class="form-control" id="document_type" name="document_type">
          <option value="report">Report</option>
          <option value="memo">Memo</option>
        </select>
      </div>
      <button type="submit" class="btn btn-dark">Search</button>
    </form>
  </div>
  <br />
  <div class="container mt-2 mx-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">文件列表</h5>
        <table class="table table-hover">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Upload Timestamp</th>
              <th scope="col">Title</th>
              <th scope="col">Type</th>
              <th scope="col">Source</th>
              <th scope="col"></th>
            </tr>
          </thead>
          <tbody>
            {% for document_meta in document_meta_list %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ document_meta['upload_timestamp'] }}</td>
              <td><a href="{{ document_meta['url'] }}" target="_blank">{{ document_meta['file_name'] }}</a></td>
              <td>{{ document_meta['document_type'] }}</td>
              <td>{{ document_meta['source'] }}</td>
              <td>
                {% if document_meta['document_type'] == 'memo' %}
                <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#reportModal" data-blob_name="{{ document_meta['blob_name'] }}">查看</button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-resizable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportModalLabel">Document Content</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <pre id="modalContent">Loading...</pre>
        </div>
        <div class="modal-footer">
          <a id="downloadButton" class="btn btn-secondary" >Download</a>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
      <div class="resizable-handle"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function () {
      $("#reportModal").on("show.bs.modal", function (event) {
        var button = $(event.relatedTarget); // 触发事件的按钮
        var blob_name = button.data("blob_name"); // 从按钮的 data-blob_name 属性获取 blob name
        var modal = $(this);
        var modalContent = modal.find("#modalContent");

        var get_content_url =
          "{{ url_for('main.get_GCS_text_file_content', blob_name='__blob_name__') }}".replace(
            "__blob_name__",
            encodeURIComponent(blob_name)
          );

        var download_file_url =
          "{{ url_for('main.download_GCS_file', blob_name='__blob_name__') }}".replace(
            "__blob_name__",
            encodeURIComponent(blob_name)
          );
        console.log(get_content_url);
        console.log(download_file_url);

        // 设置下载按钮的 href 属性
        modal.find("#downloadButton").attr("href", download_file_url);

        // 请求文件内容
        $.ajax({
          url: get_content_url,
          method: "GET",
          success: function (data) {
            var content = data.content;
            modalContent.text(content);
          },
          error: function () {
            modalContent.text("Failed to load content.");
          },
        });
      });
    });
  </script>
</body>
{% endblock %}
</html>
