<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Alphahelix Internal System{% endblock %}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- bootstrap 4-css -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- bootstrap-icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- bootstrap 4-js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <style>
      /* 自定義高度的按鈕 */
      .custom-high-button {
        height: 100px; /* 設置按鈕的固定高度 */
        line-height: 100px; /* 確保文字垂直居中 */
        font-size: 30px;
      }

      body {
        font-family: Arial, sans-serif;
      }
      nav {
        background-color: #343a40;
        box-shadow: 0 4px 2px -2px gray;
      }
      nav a {
        color: white;
        font-size: 1.3rem;
      }
      .jumbotron {
        padding: 2rem 1rem;
        text-align: center;
      }
      .jumbotron h1 {
        font-size: 3rem;
      }
      .container h1 {
        margin-top: 1.5rem;
      }
      .container .alert {
        margin-bottom: 1.5rem;
      }

      th,
      td {
        text-align: center;
      }
      table {
        width: 100%;
        table-layout: auto; /* 表头根据内容调整宽度 */
      }
      .tag {
        background-color: #e0e0e0;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 16px;
      }

      .dark-tag {
        background-color: rgb(100, 88, 88);
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 16px;
        color: white; /* 设置文字为白色 */
      }

      .true-tag {
        background-color: #6ea1d0;
        color: white;
      }

      .false-tag {
        background-color: #d86060;
        color: white;
      }

      .card {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 16px;
        background-color: #fff;
      }
      .footer-spacing {
        margin-bottom: 100px; /* Adjust the value as needed */
      }

      /* 仿照bootstrap的btn-light，製作.button-like （可用於icon背景）*/
      .button-like {
        background-color: #f8f9fa; /* 背景色，与 Bootstrap 的 btn-light 一致 */
        color: #212529; /* 文字和图标颜色 */
        padding: 0.15rem 0.35rem; /* 内边距，仿照 btn 的 padding */
        border: 1px solid #ced4da; /* 边框颜色 */
        border-radius: 0.25rem; /* 圆角 */
        text-decoration: none; /* 去掉下划线 */
        display: inline-block; /* 使元素像按钮一样 */
        font-size: 1rem; /* 字体大小 */
        line-height: 1.5; /* 行高 */
        cursor: pointer; /* 鼠标悬停时的手型指针 */
        text-align: center;
        vertical-align: middle;
      }

      .button-like:hover {
        background-color: #e2e6ea; /* 悬停时的背景色，与 btn-light 的 hover 效果一致 */
        border-color: #dae0e5; /* 悬停时的边框颜色 */
        color: #212529; /* 保持文字和图标颜色不变 */
      }

      .button-like:active {
        background-color: #dae0e5; /* 激活状态时的背景色 */
        border-color: #d3d9df; /* 激活状态时的边框颜色 */
      }

      .button-like:focus {
        outline: 0; /* 去掉焦点时的默认轮廓 */
        box-shadow: 0 0 0 0.2rem rgba(216, 217, 219, 0.5); /* 焦点时的阴影效果 */
      }

      /* 有尚未閱讀時的通知樣式 */
      .notification-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 18px;
        height: 18px;
        background-color: white;
        color: black;
        border-radius: 50%;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification-icon-gold {
        color: gold;
      }

      .notification-item {
        border: 1px solid #ddd;
        padding: 5px 10px; /* 上下 5px，左右 10px */
        margin: 4px 12px; /* 上下 4px，左右 12px */
        border-radius: 5px;
      }

      .notification-item.read {
        background-color: #f8f9fa; /* 淡灰色背景 */
        color: #6c757d; /* 淡化文字颜色 */
        opacity: 0.7; /* 降低不透明度以淡化整个元素 */
      }

      /* 覆盖 .dropdown-item 的 hover 样式，使光标变为指针 */
      .dropdown-item {
        padding: 3px 8px; /* 上下 3px，左右 8px */
      }
      .dropdown-item:hover {
        cursor: pointer;
      }
      /* 覆盖 Bootstrap 的 .dropdown-item 点击和聚焦后的背景颜色 */
      .dropdown-item:active,
      .dropdown-item:focus {
        background-color: #d3d3d3 !important; /* 设置为浅灰色 */
        color: #000000 !important; /* 设置文本颜色为黑色（可根据需求调整） */
      }
    </style>
    {% block head %}{% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <a class="navbar-brand" href="{{ url_for('main.dashboard') }}">
        Alphahelix</a
      >
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto">
          <!-- house-icon： Return to Home Page -->
          <li class="nav-item">
            <a href="{{ url_for('main.dashboard') }}"
              ><i class="nav-link bi bi-house-door-fill"></i>
            </a>
          </li>
          <!-- Bell-icon: Notification Page -->
          <li class="nav-item">
            <div class="nav-link dropdown">
              <!-- 安全調用g，避免出現undefined error -->
              {% if g.undisplayed_notification_num | default(0) > 0 %}
              <a
                id="notificationDropdown"
                data-toggle="dropdown"
                aria-expanded="false"
                href="#"
              >
                <i
                  class="bi bi-bell-fill notification-icon-gold"
                  id="notification_bell_icon"
                ></i>
                <span class="notification-badge">
                  {{ g.undisplayed_notification_num }}
                </span>
              </a>
              {% else %}
              <a
                id="notificationDropdown"
                role="button"
                data-toggle="dropdown"
                aria-expanded="false"
                href="#"
              >
                <i class="bi bi-bell-fill" id="notification_bell_icon"></i>
              </a>
              {% endif %}
              <!-- 隱藏的元素，用來存放用戶ID -->
              <input
                type="hidden"
                id="currentUserId"
                value="{{ current_user._id }}"
              />

              <ul
                class="dropdown-menu dropdown-menu-right"
                aria-labelledby="notificationDropdown"
                id="notificationDropdownMenu"
              >
                <li class="notification-item">
                  <div class="dropdown-item">
                    Only Latest 5 Notifications
                    <a
                      href="{{url_for('main.get_all_notifications', user_id=current_user._id)}}"
                      style="color: rgb(54, 118, 177); font-size: inherit"
                      >(view records)</a
                    >
                  </div>
                </li>
                {% for notification_meta in g.recent_notification_meta_list %}
                <li
                  class="notification-item {% if notification_meta['is_read'] %}read{% endif %}"
                >
                  <a
                    class="dropdown-item"
                    href="{{ url_for('main.notification_detail', notification_id=notification_meta['_id']) }}"
                    data-id="{{ notification_meta['_id'] }}"
                  >
                    <span class="notification-title"
                      >{{ notification_meta['title'] }}</span
                    >
                    <br />
                    <small>{{ notification_meta['upload_timestamp'] }}</small>
                    <br />
                    <span class="notification-content"
                      ><small
                        >{{ notification_meta['message'][:40]}}</small
                      ></span
                    >
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </li>
          <!-- Peple-icon: User Setting -->
          <li class="nav-item">
            <a href="/main/show_user_setting"
              ><i class="nav-link bi bi-file-person-fill"></i>
            </a>
          </li>
          <!-- Play-icon: For Testing -->
          <li class="nav-item">
            <a href="http://127.0.0.1:5000/main/pretrade_check_page"
              ><i class="nav-link bi bi-caret-right-square-fill"></i>
            </a>
          </li>
          <!-- Logout-->

          <li class="nav-item">
            <a class="nav-link" href="#">
              {{(current_user.username).replace('_', ' ').title()}}</a
            >
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('auth.logout') }}">logout</a>
          </li>
        </ul>
      </div>
    </nav>

    {% block content %}{% endblock %}
  </body>
</html>

<script>
  $(document).ready(function () {
    $("#notificationDropdown").on("click", function () {
      // 將通知圖示變回灰白色（检查并移除 "notification-icon-gold" 类）
      if ($("#notification_bell_icon").hasClass("notification-icon-gold")) {
        $("#notification_bell_icon").removeClass("notification-icon-gold");
      }
      // 將通知右下角的數字隐藏（notification-badge）
      $(".notification-badge").hide();

      const userId = $("#currentUserId").val();
      // 会生成类似于 /main/notifications/display/ 的基础 URL。然后通过 JavaScript 动态地将 userId 追加到 URL 的末尾。
      const apiUrl = `{{ url_for('main.mark_notification_as_displayed', user_id='') }}${userId}`;
      $.post(apiUrl, function (response) {
        console.log("All notifications marked as displayed");
      });
    });

    $("#notificationDropdownMenu").on(
      "click",
      ".dropdown-item",
      function (event) {
        event.stopPropagation(); // 阻止事件冒泡，防止菜单收起

        const notificationId = $(this).data("id");
        const apiUrl = `{{ url_for('main.mark_notification_as_read', notification_id='') }}${notificationId}`;
        // 添加父级 <li> 的 "read" 类
        $(this).closest("li").addClass("read");

        if (notificationId) {
          $.post(apiUrl, function (response) {
            console.log("Notification marked as read");
          });
        }
      }
    );
  });
</script>
{% block scripts %}{% endblock %}
