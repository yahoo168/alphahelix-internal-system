<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Alphahelix Internal System{% endblock %}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- bootstrap 4-css -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- bootstrap-icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- bootstrap 4-js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <!-- font-awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- bootstrap-icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />

    <!-- self-defined JS -->
    <script src="/static/assets/js/main.js"></script>

    <style>
      .icon-spacing {
        margin-right: 8px; /* 調整數值以改變空間大小 */
      }

      body {
        font-family: Arial, sans-serif;
      }
      nav {
        background-color: #343a40;
        box-shadow: 0 4px 2px -2px gray;
      }
      nav a {
        color: white;
        font-size: 1.3rem;
      }
      .jumbotron {
        padding: 2rem 1rem;
        text-align: center;
      }
      .jumbotron h1 {
        font-size: 3rem;
      }
      .container h1 {
        margin-top: 1.5rem;
      }
      .container .alert {
        margin-bottom: 1.5rem;
      }

      th,
      td {
        text-align: center;
      }
      table {
        width: 100%;
        table-layout: auto; /* 表头根据内容调整宽度 */
      }
      .tag {
        background-color: #e0e0e0;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 16px;
        white-space: nowrap;
        /* 防止自動換行 */
      }

      .dark-tag {
        background-color: rgb(100, 88, 88);
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 16px;
        color: white; /* 设置文字为白色 */
      }

      .true-tag {
        background-color: #6ea1d0;
        color: white;
      }

      .false-tag {
        background-color: #d86060;
        color: white;
      }

      .card {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 16px;
        background-color: #fff;
      }
      .footer-spacing {
        margin-bottom: 100px; /* Adjust the value as needed */
      }

      /* 仿照bootstrap的btn-light，製作.button-like （可用於icon背景）*/
      .button-like {
        background-color: #f8f9fa; /* 背景色，与 Bootstrap 的 btn-light 一致 */
        color: #212529; /* 文字和图标颜色 */
        padding: 0.15rem 0.35rem; /* 内边距，仿照 btn 的 padding */
        border: 1px solid #ced4da; /* 边框颜色 */
        border-radius: 0.25rem; /* 圆角 */
        text-decoration: none; /* 去掉下划线 */
        display: inline-block; /* 使元素像按钮一样 */
        font-size: 1rem; /* 字体大小 */
        line-height: 1.5; /* 行高 */
        cursor: pointer; /* 鼠标悬停时的手型指针 */
        text-align: center;
        vertical-align: middle;
      }

      .button-like:hover {
        background-color: #e2e6ea; /* 悬停时的背景色，与 btn-light 的 hover 效果一致 */
        border-color: #dae0e5; /* 悬停时的边框颜色 */
        color: #212529; /* 保持文字和图标颜色不变 */
      }

      .button-like:active {
        background-color: #dae0e5; /* 激活状态时的背景色 */
        border-color: #d3d9df; /* 激活状态时的边框颜色 */
      }

      .button-like:focus {
        outline: 0; /* 去掉焦点时的默认轮廓 */
        box-shadow: 0 0 0 0.2rem rgba(216, 217, 219, 0.5); /* 焦点时的阴影效果 */
      }

      /* 有尚未閱讀時的通知樣式 */
      .notification-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 18px;
        height: 18px;
        background-color: white;
        color: black;
        border-radius: 50%;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification-icon-gold {
        color: gold;
      }

      .notification-item {
        border: 1px solid #ddd;
        padding: 5px 10px; /* 上下 5px，左右 10px */
        margin: 4px 12px; /* 上下 4px，左右 12px */
        border-radius: 5px;
      }

      .notification-item.read {
        background-color: #e9ecef; /* 更深的灰色背景，與未讀訊息形成更強的對比 */
        color: #adb5bd; /* 使文字顏色更淡，凸顯已讀訊息 */
        opacity: 0.5; /* 降低不透明度以進一步淡化 */
        border-left: 4px solid #ced4da; /* 添加左邊框，進一步區分已讀訊息 */
      }

      /* 覆盖 .dropdown-item 的 hover 样式，使光标变为指针 */
      .dropdown-item {
        padding: 3px 8px; /* 上下 3px，左右 8px */
      }
      .dropdown-item:hover {
        cursor: pointer;
      }
      /* 覆盖 Bootstrap 的 .dropdown-item 点击和聚焦后的背景颜色 */
      .dropdown-item:active,
      .dropdown-item:focus {
        background-color: #d3d3d3 !important; /* 设置为浅灰色 */
        color: #000000 !important; /* 设置文本颜色为黑色（可根据需求调整） */
      }

      .read-title {
        color: purple; /* 已讀通知標題顏色，類似於Google已瀏覽過的網頁 */
      }

      /* Sidebar styles */
      #sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        height: 100%;
        width: 250px;
        background-color: #343a40;
        color: #fff;
        transition: all 0.2s;
        z-index: 1030;
      }
      #sidebar.active {
        left: 0;
      }

      /* 當Sidebar active時，頁面內容向右偏移 */
      #content {
        transition: margin-left 0.3s ease;
        margin-left: 0;
      }

      #sidebar.active ~ #content {
        margin-left: 250px; /* 偏移與Sidebar寬度一致 */
      }
      #sidebar .nav-link {
        color: #fff;
      }

      #sidebar .nav-link:hover,
      .nav-link:hover {
        background-color: #495057;
        color: #333; /* 母頁面懸停顏色 */
      }

      .sidebar-toggle {
        position: absolute;
        top: 20px;
        left: 20px;
        cursor: pointer;
        z-index: 1040;
      }

      /* 子頁面樣式 */
      .submenu {
        padding-left: 20px;
        transition: height 0.3s ease !important;
        overflow: hidden;
      }
      .submenu.collapse:not(.show) {
        display: none;
      }
      .submenu.collapse.show {
        display: block;
        height: auto !important;
      }

      .submenu .nav-item {
        padding-left: 20px;
      }

      /* 子頁面文字顏色 */
      .submenu-link {
        color: #007bff; /* 子頁面默認顏色 */
      }
      .submenu-link:hover {
        color: #0056b3; /* 子頁面懸停顏色 */
      }
    </style>
    {% block head %}{% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto">
          <!-- house-icon： Return to Home Page -->
          <li class="nav-item">
            <a href="{{ url_for('main.dashboard') }}"
              ><i class="nav-link bi bi-house-door-fill"></i>
            </a>
          </li>
          <!-- Bell-icon: Notification Page -->
          <li class="nav-item">
            <div class="nav-link dropdown">
              <!-- 安全調用g，避免出現undefined error -->
              {% if g.undisplayed_notification_num | default(0) > 0 %}
              <a
                id="notificationDropdown"
                data-toggle="dropdown"
                aria-expanded="false"
                href="#"
              >
                <i
                  class="bi bi-bell-fill notification-icon-gold"
                  id="notification_bell_icon"
                ></i>
                <span class="notification-badge">
                  {{ g.undisplayed_notification_num }}
                </span>
              </a>
              {% else %}
              <a
                id="notificationDropdown"
                role="button"
                data-toggle="dropdown"
                aria-expanded="false"
                href="#"
              >
                <i class="bi bi-bell-fill" id="notification_bell_icon"></i>
              </a>
              {% endif %}
              <!-- 隱藏的元素，用來存放用戶ID -->
              <input
                type="hidden"
                id="currentUserId"
                value="{{ current_user._id }}"
              />

              <ul
                class="dropdown-menu dropdown-menu-right"
                aria-labelledby="notificationDropdown"
                id="notificationDropdownMenu"
              >
                <li class="dropdown-header text-center" style="font-size: 18px">
                  <i
                    class="bi bi-chat-dots"
                    style="color: rgb(57, 99, 133)"
                  ></i>

                  <strong>Recent 10 Messages</strong>
                  (<a
                    href="{{url_for('main.get_all_notifications', user_id=current_user._id)}}"
                    class="text-primary"
                    style="font-size: inherit"
                  >
                    More </a
                  >)
                </li>

                <li class="dropdown-divider"></li>

                {% for notification_meta in g.recent_notification_meta_list %}
                <li
                  class="notification-item {% if notification_meta['is_read'] %}read{% else %}unread{% endif %}"
                >
                  <a
                    class="dropdown-item"
                    href="{{ url_for('main.notification_detail', notification_id=notification_meta['_id']) }}"
                    data-id="{{ notification_meta['_id'] }}"
                  >
                    <!-- 通知標題 & 時間 -->
                    <div class="d-flex justify-content-between">
                      <span
                        class="notification-title font-weight-bold"
                        style="
                          display: inline-block;
                          max-width: 400px;
                          white-space: nowrap;
                          overflow: hidden;
                          text-overflow: ellipsis;
                          font-size: 15px; /* 調整字體大小 */
                        "
                      >
                        {{ notification_meta['title'] }}
                      </span>

                      <span class="text-muted small" style="font-size: 12px"
                        >{{ notification_meta['upload_timestamp'] }}</span
                      >
                    </div>
                    <!-- 通知訊息（簡短） -->
                    <div
                      class="notification-content text-muted"
                      style="
                        display: inline-block;
                        max-width: 500px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        font-size: 14px;
                      "
                    >
                      <small>{{ notification_meta['message'] }}</small>
                    </div>
                  </a>
                </li>
                {% endfor %}

                <li class="dropdown-divider"></li>
              </ul>
            </div>
          </li>

          <!-- User Name:  User Setting -->
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('main.show_user_setting')}}">
              {{(current_user.username).replace('_', ' ').title()}}</a
            >
          </li>
          <!-- Logout-->
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('auth.logout') }}">logout</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Sidebar -->
    {% include "_sidebar.html" %}

    <!-- Toggle Button -->
    <div class="sidebar-toggle">
      <i
        class="fas fa-bars text-white"
        id="toggleBtn"
        style="font-size: 1.5rem"
      ></i>
    </div>
    <!-- 頁面內容（包覆在同一個div中，以便配合sidebar調整） -->
    <div id="content">{% block content %}{% endblock %}</div>
  </body>
</html>

<script>
  $(document).ready(function () {
    // 點擊toggle按鈕，切換sidebar的active狀態
    $("#toggleBtn").click(function () {
      $("#sidebar").toggleClass("active");
    });

    $("#notificationDropdown").on("click", function () {
      // 將通知圖示變回灰白色（检查并移除 "notification-icon-gold" 类）
      if ($("#notification_bell_icon").hasClass("notification-icon-gold")) {
        $("#notification_bell_icon").removeClass("notification-icon-gold");
      }
      // 將通知右下角的數字隐藏（notification-badge）
      $(".notification-badge").hide();

      // const userId = $("#currentUserId").val();
      // 会生成类似于 /main/notifications/display/ 的基础 URL。然后通过 JavaScript 动态地将 userId 追加到 URL 的末尾。
      const apiUrl = `{{ url_for('main.mark_notification_as_displayed') }}`;
      $.post(apiUrl, function (response) {
        console.log("All notifications marked as displayed");
      });
    });

    $("#notificationDropdownMenu").on(
      "click",
      ".dropdown-item",
      function (event) {
        event.stopPropagation(); // 阻止事件冒泡，防止菜单收起

        const notificationId = $(this).data("id");
        const apiUrl = `{{ url_for('main.mark_notification_as_read', notification_id='') }}${notificationId}`;
        // 添加父级 <li> 的 "read" 类
        $(this).closest("li").addClass("read");

        if (notificationId) {
          $.post(apiUrl, function (response) {
            console.log("Notification marked as read");
          });
        }
      }
    );
  });
</script>
{% block scripts %}{% endblock %}
