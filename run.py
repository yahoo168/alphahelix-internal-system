from app import create_app
import os
import base64

# 處理GCS的金鑰（因heroku無法儲存json檔，只能儲存base64編碼後的字串，故於此解碼）

# 從環境變量中獲取 base64 編碼字串，後者用於本地測試
google_credential_base64_string = "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiYWxwaGFoZWxpeGF1dG8iLAogICJwcml2YXRlX2tleV9pZCI6ICJkM2Q1MDg0ZTc2MjUwMTMyNmQ5NjA1YTc4MWQ5NGNiODhmMTUyNGU1IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdlFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLY3dnZ1NqQWdFQUFvSUJBUURDTVNmMThyTU1JTkdpXG4zOXY4Rmp4NVN5aXQ0c2hENzhPYnd2QWV0dGVzUHIwZUhMa05KbFFIczIvK0RpTHZZQStNWEFRQlBiU1A2RTFBXG5KaG83MER5aFB2aVNLL1pyV3lFMmhWb2dtN1RPbC9DV3Z1dFVNSThvQUdJOTJ3R1E0VFVxNXZLU29rNTdTYTZHXG5vbVNhVVF6MUJudGw0WkEwRS8yVDcvTUExeHFmRVVpVEU4d0hDSGx6OFJSaE82OWgvd2s5U0VVWDlZZEg1Qlh1XG44NWVib1c2QTlia1ZJT0tUVU5TcmxyZ3BMcXRlYkRsVUNRR2RPVUszVWxPNGlwMmdGTjhDcnZ1TU8yRWVmOTJ0XG5kTVdUaVJaUDh0VitlR2FVUG1NNGNkakhMWGQ0V2hkSUxGYnZkdXc0VndJNGpaMkZSMTAxTEwyMmtGRnNMY25RXG5aRjhMTjBvYkFnTUJBQUVDZ2dFQUgvS3lYbFpGZXJOVGlmWkdYTnpUcWlqaFVtcERCRnBIMWpKbUNzZU9CL3B5XG5acWZYRWdEQ1Jsb1JETDBLcGxNcGU3QVB3SnlFUGtDN3BOZ2Y3TU0vbGsrajJYaCtHLzlzSVdvaS84WmVJcmNBXG5qK3h0RHZiR05wQ0ptUitVekY4Z3ZpUXN1RThYbGxUeTc1ZDc4Wjl3QUVmR3VXWTRzVGl3dVV2NnNLS3k4SVEvXG4xQTJQMWhBZ2x2aG84UkIvNE1pQk5UdTNVNCtOWWJmQnVOSjAvd0tnVW5Wd3lIQmM2NUU5cjIzNHNNVFNVeThEXG5JNFBDRzBWRWE1c1laVFBuNzVnaGtLM0MzZ2JrUGR1ZWRhZSt2NkQ4cXlLbm5ZREk5cS9pR0ExVERQalY0VHpMXG5JZXM0VmU0WkNkMUZRdkxjellUVG1Vb25ra29SYkJweXhqRXphMGlNNFFLQmdRRHhDUDZRSHFRK25ZLzBaQ0t3XG52dit2NVdvdWE1Z0ZSalE3d1lyaldFb2tsd3lLNGxaRHA5am5mRUFYTHdFSEVlRFRZRzdNS29TVmtLekVBZ1plXG5rRXhPSncvTkNtdWoyblhMV1MvV2Rjb2I4NUd2YkdjQ2lYNk5lK3RxMkY1SWFCTGpiakovbXkxMlJkdXJyc3p0XG5id0R5a1M4L21XMmhFMWNBVjFOaU5pU3pRd0tCZ1FET1A2TjFlR3RLTW02Yy9Gbmk2KzEraUF0Z29JVXZLTzVuXG54TDZRYkdEWmNKYWVqZkErendVclZESTBLd0dNWFp1aGlPRDVCVS9HV0hpNzZuV3dPK1dabjZtTFpWTkZUQVU0XG5iajFUbk5PSVY3M3JhOEt4eWo0VlJtUnpTckxRYTlEenhuTmFhWXoycnlOMkVGL0dFSEZwc0NjU0JoenpLQkxLXG5CdzArMDc1a1NRS0JnQVQ3eForZk1wQWsyOVFXdWV6amxnL0I4NGNRTEcxM2ZSNzdLbTcyNVZtS1VmVVJKdTF4XG5LL2ZsUnNIejg5WjhsU1JwcXdESHBFUWZZS01RMDZiaTN1RUN4NzNhaUUweitCbURONHo4bEhndGVnYWhmQ08rXG5TZ0tNM0ZveUxRamNOZi9EeUlHQTZOaTRLd21Lckt3QURvbjFYSCs1SVY0aU16dExrdXJGNmM1WEFvR0FjQUR6XG5QYW5sYWVlMVZoOWNtUFRTaG5KTzYyeUFwem10TGtFVDA4NW5VZTNvZmJaTEQzRFJOOVNEWnYwcjNCUkJuaGw5XG5RdjUxY2hzOWhaOHZ4a0xnenVwNzRpMW1hUzE5Y0VXOW5CaUFiM3htc09CV1hNS2RzR1FIek94MTZ1V0NGY0JoXG5pR25sbVZsSEFxaWx1aVBYMHpOTUpHZVpkUnNBQ1NLSE9PVTRjYkVDZ1lFQXZFdk1LczkwRTJPamxUdXpncnFVXG5ZNWhSdGhtQ2lHL2Y5SzdyMnRlUEtsS1lXSzYyWmtKcjZkK20wdmQyYzRBamxjU2JlL09JTi93Tms4UWpiOVJFXG5DSFlFQnN6NTZEYnZVWHRqK2FpTVhRaERvL0ZvMlc5d1dLRXZRV3ZVbVAwa2s4UXQra3owdm02N05IWXIzVTlJXG5HTHptSWFVNGFEVlBLN1puUDRTSFFUbz1cbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJqZWZmLWNoZW5AYWxwaGFoZWxpeGF1dG8uaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTAwOTQ3Nzk4MTUwNjM0OTI2NzQ5IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9qZWZmLWNoZW4lNDBhbHBoYWhlbGl4YXV0by5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo="
encoded_key = os.getenv('GOOGLE_APPLICATION_CREDENTIALS_BASE64', google_credential_base64_string)
# 解碼 base64 字串
decoded_key = base64.b64decode(encoded_key)

# 將解碼後的內容寫入臨時檔案
temp_gcp_key_path = '/tmp/gcp_key.json'
with open(temp_gcp_key_path, 'wb') as temp_file:
    temp_file.write(decoded_key)
    
# 設置 GOOGLE_APPLICATION_CREDENTIALS 環境變量指向臨時檔案
os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = temp_gcp_key_path

app = create_app()
#把app context推入stack中，擴張到整個應用
app.app_context().push()

if __name__ == '__main__':
    app.run(debug=True)